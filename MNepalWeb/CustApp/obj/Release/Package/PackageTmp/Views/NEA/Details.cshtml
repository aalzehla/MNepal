@model CustApp.Models.NEAFundTransfer

@{
    ViewBag.Title = "NEA Payment";
    string hasBankKYC = ViewBag.HasBankKYC;
}

<!-- Main content -->
<link href="~/Content/NewIcon/style.css" rel="stylesheet" />
<style>
    .image_icon {
        width: 100px;
    }

    .field-icon {
        float: right;
        margin-left: -25px;
        margin-top: -32px;
        margin-right: 13px;
        position: relative;
        z-index: 2;
    }

    table {
        width: 100%;
        font-size: medium;
        border-spacing: 0;
    }

    table, th, td {
        border: 1px solid gray;
        border-collapse: collapse;
        padding: 2px 3px 2px 3px;
        border-color: rgb(193, 193, 193);
    }

    th, td {
        /*padding: 5px 5px 5px 5px;*/
        text-align: left;
        overflow-x: auto;
    }

    /*table tr:nth-child {
        background-color: gray;
    }*/

    /*table th {
        background-color: MediumSeaGreen;
        color: white;
    }*/
</style>


@using (Html.BeginForm("NEAExecutePayment", "NEA", FormMethod.Post, new { @id = "NEAExecutePayment", @name = "NEAExecutePayment", @class = "form-horizontal", enctype = "multipart/form-data" }))
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true)




    <div class="main-content">
        <div class="two-colbg">
            <div class="container">
                <div class="row">

                    <div class="col-lg-6">
                        <section class="internet-payment pad-50">
                            <div class="top-section">
                                <h2 class="title">NEA Bill Payment</h2>
                                <p>Please select the NEA counter and fill the required field.</p>
                            </div>
                            <div class="instant-transactions">
                                <h3 class="title">Other Merchant Payment</h3>
                                <div class="transactions-grid clearfix">
                                    <div class="item load-wallet">
                                        <div class="item-inner">
                                            <a href="@Url.Action("MerchantRestaurant", "MerchantPayment")">
                                                <div class="content-inner">
                                                    <i class="thaili-icon-restaurant"></i>
                                                    <span>Restaurant</span>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                    <!-- /item -->

                                    <div class="item transfer-fund">
                                        <div class="item-inner">
                                            <a href="@Url.Action("MerchantCollege", "MerchantPayment")">
                                                <div class="content-inner">
                                                    <i class="thaili-icon-college"></i>
                                                    <span>College</span>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                    <!-- /item -->

                                    <div class="item top-up">
                                        <div class="item-inner">
                                            <a href="@Url.Action("MerchantSchool", "MerchantPayment")">
                                                <div class="content-inner">
                                                    <i class="thaili-icon-school"></i>
                                                    <span>School</span>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                    <!-- /item -->

                                    <div class="item top-up">
                                        <div class="item-inner">
                                            <a href="@Url.Action("MerchantInsurance", "MerchantPayment")">
                                                <div class="content-inner">
                                                    <i class="thaili-icon-school"></i>
                                                    <span>Insurance</span>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                    <!-- /item -->
                                    <div class="item top-up">
                                        <div class="item-inner">
                                            <a href="@Url.Action("Index", "NEA" )">
                                                <div class="content-inner">
                                                    <i class="thaili-icon-electricity"></i>
                                                    <span>NEA</span>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                    <!-- /item -->
                                    <div class="item top-up">
                                        <div class="item-inner">
                                            <a href="@Url.Action("Index", "Khanepani" )">
                                                <div class="content-inner">
                                                    <i class="thaili-icon-khanepani"></i>
                                                    <span>Khanepani</span>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                    <!-- /item -->
                                    <div class="item top-up">
                                        <div class="item-inner">
                                            <a href="@Url.Action("Index", "NepalWater" )">
                                                <div class="content-inner">
                                                    <i class="thaili-icon-khanepani"></i>
                                                    <span>Nepal Water</span>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                    <!-- /item -->
                                </div>
                            </div>
                        </section>

                    </div>

                    <div class="col-lg-6 right-form">
                        <section class="content-inner pad-50">
                            @if (this.ViewData["NEA_messsage"] != null)
                            {
                                if (this.ViewData["message_class"].ToString() == "success_info")
                                {
                                    <div class="alert alert-success">
                                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                                        <h4>Success</h4> @this.ViewData["NEA_messsage"]
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-danger">
                                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                                        <h4>Error</h4> @this.ViewData["NEA_messsage"]
                                    </div>
                                }
                            }

                            <div class="box-header with-border">
                                <h2 class="title">Confirm Payment</h2>
                            </div>
                            <div class="row">
                                <div class="col-md-5">
                                    <label>NEA Counter:</label>
                                </div>
                                <div class="col-md-6">
                                    <label>@ViewBag.NEABranchName</label>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-5">
                                    <label>Customer ID:</label>
                                </div>
                                <div class="col-md-6">
                                    <label>@ViewBag.CustomerID</label>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-5">
                                    <label>SC No.:</label>
                                </div>
                                <div class="col-md-6">
                                    <label>@ViewBag.SCNo</label>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-5">
                                    <label>Customer Name:</label>
                                </div>
                                <div class="col-md-6">
                                    <label>@ViewBag.CustomerName</label>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-5">
                                    <label>Total Due Amount:</label>
                                </div>
                                <div class="col-md-6">
                                    <label>RS.@ViewBag.TotalAmountDue</label>
                                </div>
                            </div>

                            <div class="row NoPendingBills" style="color:green; display:none">
                                <div class="col-md-5">
                                    <label>Status:</label>
                                </div>
                                <div class="col-md-6">
                                    <label>No Pending Bills</label>
                                </div>
                            </div>

                            <div class="row AdvAmt Input-Section" style="color:green; display:none">
                                <div class="col-md-5">
                                    <label>Advance Amount:</label>
                                </div>
                                <div class="col-md-6">
                                    <label id="AdvAmt" oninput="checkValidation()">0</label>
                                </div>
                            </div>
                            <br />
                            <table class="Input-Section NEA_Table">
                                <tr>
                                    <th>Due Bill Of</th>
                                    <th>Bill Date</th>
                                    <th>Bill Amount</th>
                                    <th>Status</th>
                                    <th>Payable Amount</th>
                                </tr>

                                @for (int i = 0; i < @ViewBag.rowNo; i++)
                                {
                                    <tr>
                                        <td>
                                            @ViewBag.ListDetails[i].destination
                                        </td>
                                        <td>
                                            @ViewBag.ListDetails[i].billDate
                                        </td>
                                        <td>
                                            NPR.@ViewBag.ListDetails[i].billAmount
                                        </td>
                                        <td>
                                            @ViewBag.ListDetails[i].status
                                        </td>
                                        <td>
                                            NPR.@ViewBag.ListDetails[i].amount
                                        </td>
                                    </tr>
                                }
                            </table>
                            <br />
                            <div class="transfer-order clearfix Input-Section">
                                <h3 class="title">Pay from</h3>

                                <select class="form-control selectpicker transaction-select from col-md-9" id="TransactionMedium" name="TransactionMedium" onmousedown="this.value='';">
                                    <option data-icon="thaili-icon-load-wallet" value="00">Wallet</option>
                                    @if (hasBankKYC.Equals("T"))
                                    {
                                        <option data-icon="thaili-icon-bank" value="10">Bank</option>
                                    }
                                </select>
                            </div>
                            <div class="row Input-Section">
                                <div class="col-md-6">
                                    <label>
                                        Amount(<span style="color:red">*</span>)
                                    </label>
                                    <div class="form-group  input-group">
                                        <div class="form-control col-4">NPR.</div>
                                        @Html.TextBox("amount", (int)ViewBag.S_TotalAmountDue, new
                                       {
                                           @class = "form-control",
                                           @title = "Please use Amount",
                                           @placeholder = "Amount",
                                           @maxlength = "6",
                                           @oninput = "checkValidation()",
                                           @onkeypress = "return isNumber(event)",//NumberDot(event)",
                                           @autocomplete = "off"
                                       })

                                    </div>
                                    <div class="form-group" id="AmtErr" style="color:red; margin-top:-11px;"></div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="@Html.NameFor(x=>x.TPin)"> @Html.DisplayNameFor(x => x.TPin) (<span style="color:red">*</span>)</label>

                                        @Html.PasswordFor(x => x.TPin, new { @class = "form-control pwd1", @title = "Please use T-Pin number", @placeholder = "T-Pin", @maxlength = "4", @onkeypress = "return isNumber(event)", @oninput = "checkValidation()", @autocomplete = "new-password", @onpaste = "return false" })
                                        <span toggle="#password-field" class="fa fa-fw fa-eye field-icon toggle-password, btnShow1"></span>
                                    </div>
                                    <div class="form-group" id="PinErr" style="color:red; margin-top:-11px;"></div>
                                </div>

                            </div>
                            <div class="row Input-Section">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="@Html.NameFor(x=>x.Remarks)"> @Html.DisplayNameFor(x => x.Remarks) (<span style="color:red">*</span>)</label>

                                        @Html.TextAreaFor(x => x.Remarks, new { @class = "form-control", @title = "Please insert Remarks", @placeholder = "Remarks", @maxlength = "30", @oninput = "checkValidation()" })

                                    </div>
                                    <div class="form-group" id="RemarkErr" style="color:red; margin-top:-11px;"></div>
                                </div>

                            </div>

                            <br />

                            <div class="box-footer Input-Section">
                                <input type="submit" class="btn btn-blue btn-big col-md-5" name="btnCommand" value="Confirm" id="btnSubmit" />
                                <input type="button" value="Clear" class="btn btn-default btn-big col-md-5" id="clearButton" />
                            </div>

                        </section>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Expire 3 Months Time Limit -->
    <div class="modal fade common-modal" id="expireModel" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="success-icon">
                        <img src="~/Content/assets/img/denied-cross.svg" alt="denied-cross">
                    </div>
                    <p style="color: #E31837; font-size: 1.111rem; font-weight: 700;">Please Visit NEA Counter</p>
                    @*<span style="color: #E31837; font-size: 1.111rem; font-weight: 700;">Time Limit Exceed</span>*@
                    <br /> <br />
                    <button type="button" class="btn btn-blue" data-dismiss="modal" style="width:80%">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success modal -->
    <div class="modal fade common-modal" id="successModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="success-icon">
                        <img src="~/Content/assets/img/success-tick.svg" alt="success-tick">
                    </div>
                    <p class="msg">@*Success!*@</p>
                    <span class="msg">Your payment has been confirmed.</span>
                    <br /> <br />
                    <button type="button" class="btn btn-blue" data-dismiss="modal" style="width:80%">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Failure modal -->
    <div class="modal fade common-modal" id="failureModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="success-icon">
                        <img src="~/Content/assets/img/denied-cross.svg" alt="denied-cross">
                    </div>
                    <p style="color: #E31837; font-size: 1.111rem; font-weight: 700;">@*Error!*@</p>
                    <span style="color: #E31837; font-size: 1.111rem; font-weight: 700;" id="message"></span>
                    <br /> <br />
                    <button type="button" class="btn btn-blue" data-dismiss="modal" style="width:80%">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Failure modal session expired -->
    <div class="modal fade common-modal" id="failureModalSessionExpired" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="success-icon">
                        <img src="~/Content/assets/img/denied-cross.svg" alt="denied-cross">
                    </div>
                    <p style="color: #E31837; font-size: 1.111rem; font-weight: 700;">@*Error!*@</p>
                    <span style="color: #E31837; font-size: 1.111rem; font-weight: 700;">Session expired. Please login again</span>
                    <br /> <br />
                    <button type="button" class="btn btn-blue" data-dismiss="modal" style="width:80%">OK</button>
                </div>
            </div>
        </div>
    </div>
}

@section scripts{


    <script type="text/javascript">

        $(".btnShow1").mousedown(function () {
            $(".pwd1").attr("type", "text");
        });
        $(".btnShow1").on("mouseleave", function () {
            $(".pwd1").attr("type", "password");
        });

        $(document).ready(function () {

            //If Total pending bill months is more then 3
            var rowNo = parseInt(@ViewBag.rowNo);
            if (rowNo < 0 || rowNo > 3) {
                $(".Input-Section").hide();
                $('#expireModel').modal("show");
            }
            if (rowNo == 0) {
                $(".NEA_Table").hide();
            }
            //If Total Due amount is equal to zero
            var PayingAmount = parseInt(@ViewBag.S_TotalAmountDue);
            if (PayingAmount == 0) {
                $(".Input-Section").hide();
                $(".NoPendingBills").show();
            }
        });

        document.getElementById("successModal").onclick = function () {
         var url = '@Url.Action("Index", "NEA")';
         window.location.href = url;
        };
        document.getElementById("failureModalSessionExpired").onclick = function () {
         var url = '@Url.Action("Index", "LogOut")';
         window.location.href = url;
        };
        document.getElementById("expireModel").onclick = function () {
         var url = '@Url.Action("Index", "NEA")';
         window.location.href = url;
        };

        function isNumber(evt) {
            evt = (evt) ? evt : window.event;
            var charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            return true;
        }
        function NumberDot(evt) {
            var charCode = (evt.which) ? evt.which : event.keyCode
            if (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57))
                return false;

            return true;
        }
        function noCharacter(evt) {
            evt = (evt) ? evt : window.event;
            var charCode = (evt.which) ? evt.which : evt.keyCode;
            if ((charCode > 32 && charCode < 48) || (charCode > 57 && charCode < 65) || (charCode > 90 && charCode < 97) || (charCode > 122 && charCode < 127)) {
                return false;
            }
            return true;
        }
        ///for amount input number and dot only
        function NumberDot(evt) {
            var charCode = (evt.which) ? evt.which : event.keyCode
            if (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57))
                return false;

            return true;
        }
        
        function checkValidation() {
            debugger;
            var remarks = $("[name='Remarks']").val();
            var amount1 = $("[name='amount']").val();
            var amount = parseFloat($("[name='amount']").val());
            var pin = $("[name='TPin']").val();
            var TotaldueAmount = parseFloat(@ViewBag.TotalAmountDue);
            var AdvanceAmount = amount - TotaldueAmount;

            
            if ((amount1.trim() == "") || (amount == "0.00") || (amount == "0") || (amount < TotaldueAmount)) {
                $("#AmtErr").html("");
                $("#AmtErr").append("<small>" + "Amount cannot be less then Total Due Amount" + "</small>");
                $("#AmtErr").show();
                $(".AdvAmt").hide();
            }
            else if (amount>'100000') {
                $("#AmtErr").html("");
                $("#AmtErr").append("<small>" + "Amount cannot exceed more then NRS.100000" + "</small>");
                $("#AmtErr").show();
                $(".AdvAmt").hide();
            }
            else {
                $("#AmtErr").hide();
                $("#AdvAmt").html("");
                if ((amount > TotaldueAmount) && (AdvanceAmount > 0)) {
                    $("#AdvAmt").html("RS.");
                    $("#AdvAmt").append(AdvanceAmount.toFixed(2));
                    $(".AdvAmt").show();
                }
                else {
                    $("#AdvAmt").html("0");
                }
            }

            if (pin.trim() == "") {
                $("#PinErr").html("");
                $("#PinErr").append("<small>" + "Please Enter the T-Pin" + "</small>");
                $("#PinErr").show();
            }
            else if (pin.length != 4) {
                $("#PinErr").html("");
                $("#PinErr").append("<small>" + "T-Pin must be 4 character long." + "</small>");
                $("#PinErr").show();
            }
            else {
                $("#PinErr").hide();
            }

            if (remarks.trim() == "") {
                $("#RemarkErr").html("");
                $("#RemarkErr").append("<small>" + "Please Enter Remarks" + "</small>");
                $("#RemarkErr").show();
            }
            else {
                $("#RemarkErr").hide();
            }
        }

        $("#clearButton").click(function () {

            $("[name='amount']").val("");
            $("[name='Remarks']").val("");
            $("[name='TPin']").val("");
        });

        $('#btnSubmit').click(function (e) {
            e.preventDefault();

            var Remarks = $("[name='Remarks']").val();
            var amount = $("[name='amount']").val();
            var TPin = $("[name='TPin']").val();
            var servicecode = $("[name='TransactionMedium']").val();

            if ((amount != "")&& (Remarks != "") && (TPin != "") && (TPin.length == 4)) {

                var dataToPost = {
                    TransactionMedium: servicecode,
                    amount: amount,
                    Remarks: Remarks,
                    TPin: TPin

                };

                e.preventDefault(); //prevent the default action
                $.ajax({
                    url: '@Url.Action("NEAExecutePayment", "NEA")',
                    type: "POST",
                    data: dataToPost,
                    async: false,
                    success: function (data) {

                        if (data.responseCode == "200") {
                            $("#ajaxResponse").html("");
                            var resp = JSON.parse(data.responseText);
                            $('#successModal').modal("show");
                            $("#TPin").val("");
                            $("#Remarks").val("");
                            $("#amount").val("");


                        }
                        //display error message
                        else {
                            $("#ajaxResponse").html("");
                            $("#message").html("");
                            $("#message").append(data.responseText);
                            if (data.responseText == "Session expired. Please login again") {
                                $('#failureModalSessionExpired').modal("show");
                            }
                            else {
                                $('#failureModal').modal("show");
                            }

                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert('Failed to retrieve.');
                        $("#message").html("");
                        $("#message").append(jqXHR.responseText);
                        $('#failureModal').modal("show");

                    },
                    //capture the request before it was sent to server
                    beforeSend: function (jqXHR, settings) {
                        //adding some Dummy data to the request
                        settings.data += "&dummyData=whatever";
                        //disable the button until we get the response
                        $('#btnSubmit').attr("disabled", true);
                    },
                    complete: function (jqXHR, textStatus) {
                        //enable the button
                        $('#btnSubmit').attr("disabled", false);
                    }
                });

            }
            else {
                checkValidation();
                $("#message").html("");
                $("#message").append("Please Enter the required fields.");
                $('#failureModal').modal("show");

            }
        });
    </script>

}



