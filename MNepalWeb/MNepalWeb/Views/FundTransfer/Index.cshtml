
@{
    ViewBag.Title = "Fund Transfer";
}

@model MNepalWeb.Models.MNFundTransfer
<!-- =============================================== -->
<!-- Content Header (Page header) -->

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.11.0/build/css/alertify.min.css" />
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.11.0/build/css/themes/default.min.css" />
<section class="content-header">
    <h1>
        Payment
        <small> Fund Transfer</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-user"></i> Payment</a></li>
        <li class="active">  Fund Transfer</li>
    </ol>
</section>
@*<section class="content-header">
    <h1>
        Fund Transfer
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Dashboard</a></li>
        <li class="active">Fund Transfer</li>
    </ol>
</section>*@

<!-- Main content -->
<section class="content">
    <!-- Main row -->
    <div class="row">

        <div class="col-md-8">

            <div class="box box-info">
                <div class="box-header">
                    <h3 class="box-title">Fund Transfer</h3>
                </div>
                <!-- /.box-header -->
                

                @using (Html.BeginForm( new { @id = "frmFundTransfer" }))//"Index", "FundTransfer", FormMethod.Post,
                {
                    <div id="ajaxResponse">
                    </div>

                    if (this.ViewData["fundTransfer_messsage"] != null)
                    {
                        if (this.ViewData["message_class"].ToString() == "success_info")
                        {
                            <div class="alert alert-success">
                                <button type="button" class="close" data-dismiss="alert">&times;</button>
                                <h4>Success</h4> @this.ViewData["fundTransfer_messsage"]
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-danger">
                                <button type="button" class="close" data-dismiss="alert">&times;</button>
                                <h4>Error</h4> @this.ViewData["fundTransfer_messsage"]
                            </div>
                        }
                    }
                @*<form id="frmFundTransfer">
                    <div id="ajaxResponse">
                    </div>*@
                    <div class="box-body">
                        <!-- /.form-group -->
                        <div class="form-group">
                            <label>Trace ID</label>
                            @Html.EditorFor(model => model.tid, new { htmlAttributes = new { @class = "form-control", @readonly = "readonly", @Value = @ViewBag.TraceID, @name = "txtTraceID", @id = "traceID" } })
                        </div>

                        <div class="form-group">
                            <label>Sender Mobile No</label>
                            <input type="text" id="sender" name="txtSenderMobileNo" class="form-control" value="@ViewBag.SenderMobileNo" readonly />
                        </div>

                        <div class="form-group">
                            <label>Transaction Medium</label>
                            <select class="form-control select2" id="fundTransferType" name="txtFundTransferType" style="width: 100%;">
                                <option selected="selected" value="Wallet to Wallet">wallet to wallet</option>
                                <option value="Wallet to Bank">Wallet to bank</option>
                                <option value="Bank to Wallet">Bank to Wallet</option>
                                <option value="Bank to Bank"> Internal Account Transfer</option>
                            </select>
                        </div>

                        <div class="form-group" style="display:none;">
                            <label>Service Code </label>
                            <input type="text" class="form-control" id="ServiceCode" name="txtServiceCode" value="@ViewBag.ServiceCode" readonly />
                        </div>

                        <div class="form-group">
                            <label>Recipient Mobile Number</label>
                            <input type="text" id="recipient" name="txtRecipientNo" class="form-control" placeholder="Recipient No" pattern=".{10,10}" required title="Please use phone Number" maxlength="10" onkeypress="return isNumber(event)"/>
                            <label id="check">                </label>
                        </div>

                        <div class="form-group">
                            <label>Amount</label>
                            <input type="text" id="amount" name="txtAmount" class="form-control" placeholder="Amount"
                                   pattern=".{2,4}" required title="Please use 4 digit amount" maxlength="6" onkeypress="return isNumber(event)"/>
                        </div>

                        <div class="form-group">
                            <label>T-PIN</label>
                            <input type="password" id="pin" name="txtPin" class="form-control" placeholder="T-PIN" pattern=".{4,4}" required title="Please use the Pin number"  maxlength="4"/>
                        </div>

                        <div class="form-group">
                            <label>Purpose</label>
                            <textarea class="form-control" rows="3" id="note" name="txtNote" placeholder="Note Enter ..." pattern=".{0}|.{,40}" required title="Please use the Pin number"></textarea>
                        </div>

                        <div class="form-group" style="display:none;">
                            <label>SRC</label>
                            <input type="text" id="src" name="txtSrc" class="form-control" value="WEB" />
                        </div>
                        <!-- /.form-group -->
                    </div>
                    <!-- /.box-body -->

                    <div class="box-footer">
                        <input type="submit" class="btn btn-primary pull-right" id="btnSubmit" name="txtSubmit" value="Submit" />
                        <a href="@Url.Action("Index","FundTransfer")" class="btn btn-primary pull-right" id="btnNew" title="Begin New Transaction">New Transaction</a>

                       
                    </div>
                    
                 }
               
               </div>
        </div>

        <div class="col-md-2"> &nbsp; </div>

    </div>
    <!-- /.row -->
</section>
<!-- /.content -->
<!-- =============================================== -->

@section scripts{

    <!-- Load jQuery and the validate plugin -->
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.js"></script>

    <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/bootstrap-validator/0.4.5/js/bootstrapvalidator.min.js'></script>

    <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.11.0/build/alertify.min.js"></script>

    <!--jQuery Form Validation code -->
    <script type="text/javascript">

        function isNumber(evt) {
            evt = (evt) ? evt : window.event;
            var charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            return true;
        }

        $("#recipient").change(function (event) {
            event.preventDefault();

            var id = $("#recipient").val();
            $.ajax({
                cache: false,
                type: "GET",
                url: '@Url.Action("GetCheckingUserName", "Customer")',
                data: { "Username": id },
                success: function (data, textStatus) {
                    var markup = data;
                    if (data == "Success") {
                        $("#check").html("");
                        $("#check").css("color", "red");
                        $("#check").html("Number Not Registered").show();
                    }
                    else {
                        $("#check").html("");
                        $("#check").css("color", "green");
                        $("#check").html("Valid Number").show();
                    }
                },
                error: function () {
                    alert("Data Not Found");
                }
            });
        });

        $(document).ready(function () {

            $(window).keydown(function (event) {
                if (event.keyCode == 13) {
                    event.preventDefault();
                    return false;
                }
            });


            $('#btnNew').hide();
            if ($("select[name='txtFundTransferType'] option:selected").val() == 'Wallet to Wallet') {
                //alert(($("select[name='txtFundTransferType'] option:selected").val()))
                $("#ServiceCode").html(""); //WalletToWallet
                $("#ServiceCode").val("00");
            }

            $("#fundTransferType").change(function () {
                var id = $("#fundTransferType").val();
                $.ajax({
                    cache: false,
                    type: "GET",
                    url: '@Url.Action("GetServiceCode", "FundTransfer")',
                    data: { "txtFundTransferType": id },
                    success: function (data, textStatus) {
                        $("#ServiceCode").html("");
                        var markup = data;
                        $("#ServiceCode").val(data);
                    },
                    error: function () {
                        alert("Data Not Found");
                    }
                });
        });


        $('#frmFundTransfer').bootstrapValidator({
            feedbackIcons: {
                valid: 'glyphicon glyphicon-ok',
                invalid: 'glyphicon glyphicon-remove',
                validating: 'glyphicon glyphicon-refresh'
            },
            fields: {
                txtRecipientNo: {
                    validators: {
                        phone: {
                            country: 'Nepal',
                            message: 'The phone number is not valid'
                        }
                    }
                },
                txtAmount: {
                    validators: {
                        integer: {
                            message: 'The value is not an integer'
                        },
                        notEmpty: {
                            message: 'The Amount is required and cannot be empty'
                        },
                        stringLength: {
                            max: 4,
                            min: 2,
                            message: 'The Amount must be more than 2 and less than 4 characters long'
                        }
                    }
                },
                txtPin: {
                    validators: {
                        integer: {
                            message: 'The value is not an integer'
                        },
                        notEmpty: {
                            message: 'The pin is required and cannot be empty'
                        },
                        stringLength: {
                            max: 4,
                            min: 4,
                            message: 'The pin must be 4 digit numeric password'
                        }
                    }
                }
            }
        });


        $("#ajaxResponse").hide();

        $('#btnSubmit').click(function (e) {
            e.preventDefault();

            var tid = $("[name='txtTraceID']").val();
            var servicecode = $("[name='txtServiceCode']").val();
            var umobile = $("[name='txtSenderMobileNo']").val();
            var recipientNo = $("[name='txtRecipientNo']").val();
            var amount = $("[name='txtAmount']").val();
            var pin = $("[name='txtPin']").val();
            var note = $("[name='txtNote']").val();
            var src = $("[name='txtSrc']").val();

            if (recipientNo.length != 10) {
                $("[name='txtRecipientNo']").focus();
                alertify.error('Mobile number must be of 10 digits');
                return;
            }

            if (recipientNo.substring(0,2)!="98") {
                $("[name='txtRecipientNo']").focus();
                alertify.error('Mobile number must start with 98');
                return;
            }
            if (amount.trim() == "")
            {
                $("[name='txtAmount']").focus();
                alertify.error('Amount cannot be empty');
                return;
            }
            if (amount.trim() == "0") {
                $("[name='txtAmount']").focus();
                alertify.error('Amount cannot be 0');
                return;
            }
            if (pin.trim() == "") {
                $("[name='txtPin']").val()
                alertify.error('Pin cannot be empty');
                return;
            }
            if ((recipientNo != "") && (amount != "") && (pin != "") && (note != "")) {

                var dataToPost = {
                    tid: tid,
                    sc: servicecode,
                    mobile: umobile,
                    da: recipientNo,
                    amount: amount,
                    pin: pin,
                    note: note,
                    sourcechannel: src
                };

                e.preventDefault(); //prevent the default action
                $.ajax({
                    url: '@Url.Action("FundTransferTran", "FundTransfer")',
                    type: "POST",
                    data: dataToPost,
                    async: false,
                    success: function (data) {
                        //alert('success');
                        //alert(data.responseCode);
                        //alert(data.responseText);
                        debugger;
                        if (data.responseCode == "200") { //
                            debugger;
                            $("#ajaxResponse").html("");
                            var resp = JSON.parse(data.responseText);
                            var AppendText = "<div class='alert alert-success'><h4>Success</h4>";
                            AppendText = AppendText + resp.message;
                            AppendText = AppendText + "<br/>Available Balance:" + resp.availableBalance;
                            AppendText = AppendText + "<br/></div>";
                            $("#ajaxResponse").append(AppendText);
                            $("#ajaxResponse").show();
                            $('#btnNew').show();
                            $('#btnSubmit').hide();

                        }
                        //display error message
                        else {
                            $("#ajaxResponse").html("");
                            $("#ajaxResponse").append("<div class='alert alert-danger'><h4>Error</h4>"
                                + data.responseText + "<br/></div>");
                            $("#ajaxResponse").show();
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert('Failed to retrieve.');
                        $("#ajaxResponse").html("");
                        $("#ajaxResponse").append(jqXHR.responseText);
                        $("#ajaxResponse").show();
                    },
                    //capture the request before it was sent to server
                    beforeSend: function (jqXHR, settings) {
                        //adding some Dummy data to the request
                        settings.data += "&dummyData=whatever";
                        //disable the button until we get the response
                        $('#btnSubmit').attr("disabled", true);
                    },
                    complete: function (jqXHR, textStatus) {
                        //enable the button
                        $('#btnSubmit').attr("disabled", false);
                    }
                });

            }
            else {
                $("#ajaxResponse").html("");
                $("#ajaxResponse").append("<div class='alert alert-danger'><h4>Error</h4>"
                    + "Please Enter the required Field" + "<br/></div>");
                $("#ajaxResponse").show();
            }
        });

    });

    </script>
}